generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantType {
  ADMINISTRADORA
  EDIFICIO_AUTOGESTION
}

enum Role {
  SUPER_ADMIN
  TENANT_OWNER
  TENANT_ADMIN
  OPERATOR
  RESIDENT
}

enum UnitOccupantRole {
  OWNER
  RESIDENT
}

// ============================================================================
// FINANZAS (Charges, Payments, Allocations)
// ============================================================================

enum ChargeStatus {
  PENDING
  PARTIAL
  PAID
  CANCELED
}

enum PaymentStatus {
  SUBMITTED
  APPROVED
  REJECTED
  RECONCILED
}

enum PaymentMethod {
  TRANSFER
  CASH
  CARD
  ONLINE
}

enum ChargeType {
  COMMON_EXPENSE
  EXTRAORDINARY
  FINE
  CREDIT
  OTHER
}

model Tenant {
  id                    String                 @id @default(cuid())
  name                  String                 @unique
  type                  TenantType
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  memberships           Membership[]
  buildings             Building[]
  auditLogs             AuditLog[]
  subscription          Subscription?
  tickets               Ticket[]
  ticketComments        TicketComment[]
  communications        Communication[]
  communicationTargets  CommunicationTarget[]
  communicationReceipts CommunicationReceipt[]
  files                 File[]
  documents             Document[]
  vendors               Vendor[]
  vendorAssignments     VendorAssignment[]
  quotes                Quote[]
  workOrders            WorkOrder[]
  charges               Charge[]
  payments              Payment[]
  paymentAllocations    PaymentAllocation[]
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  name                  String
  passwordHash          String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  memberships           Membership[]
  unitOccupants         UnitOccupant[]
  auditLogs             AuditLog[]
  ticketsCreated        Ticket[]               @relation("TicketCreatedBy")
  ticketComments        TicketComment[]        @relation("TicketCommentAuthor")
  communicationReceipts CommunicationReceipt[]
  paymentsCreated       Payment[]              @relation("PaymentCreatedBy")
}

model Membership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant                Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  roles                 MembershipRole[]
  assignedTickets       Ticket[]
  communicationsCreated Communication[]
  filesCreated          File[]
  documentsCreated      Document[]
  assignedWorkOrders    WorkOrder[]           @relation("WorkOrderAssignedTo")
  chargesCreatedBy      Charge[]
  paymentsReviewedBy    Payment[]

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
}

model MembershipRole {
  id           String     @id @default(cuid())
  membershipId String
  role         Role
  membership   Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@unique([membershipId, role])
  @@index([role])
}

model Building {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant                Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  units                 Unit[]
  tickets               Ticket[]
  communications        Communication[]
  documents             Document[]
  vendorAssignments     VendorAssignment[]
  quotes                Quote[]
  workOrders            WorkOrder[]
  charges               Charge[]
  payments              Payment[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Unit {
  id              String   @id @default(cuid())
  buildingId      String
  code            String
  label           String?
  unitType        String   @default("APARTMENT") // APARTMENT, HOUSE, OFFICE, STORAGE, PARKING
  occupancyStatus String   @default("UNKNOWN") // UNKNOWN, VACANT, OCCUPIED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  building      Building       @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unitOccupants UnitOccupant[]
  tickets       Ticket[]
  documents     Document[]
  charges       Charge[]
  payments      Payment[]

  @@unique([buildingId, code])
  @@index([buildingId])
}

model UnitOccupant {
  id        String           @id @default(cuid())
  unitId    String
  userId    String
  role      UnitOccupantRole
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([unitId, userId, role])
  @@index([unitId])
  @@index([userId])
}

// ============================================================================
// AUDIT LOGGING (OPCIÓN A — SUPER_ADMIN Backend)
// ============================================================================

enum AuditAction {
  // SUPER_ADMIN
  TENANT_CREATE
  TENANT_UPDATE
  TENANT_DELETE
  SUBSCRIPTION_CREATE
  SUBSCRIPTION_UPDATE
  SUBSCRIPTION_CANCEL
  USER_CREATE
  USER_DELETE
  OTHER
  // AUTH
  AUTH_LOGIN
  AUTH_LOGOUT
  AUTH_FAILED_LOGIN
  MEMBERSHIP_INVITE_SENT
  MEMBERSHIP_ROLE_CHANGED
  // IMPERSONATION
  IMPERSONATION_START
  IMPERSONATION_END
  // BUILDING/UNIT
  BUILDING_CREATE
  BUILDING_UPDATE
  BUILDING_DELETE
  UNIT_CREATE
  UNIT_UPDATE
  UNIT_DELETE
  OCCUPANT_ASSIGN
  OCCUPANT_REMOVE
  // TICKETS
  TICKET_CREATE
  TICKET_UPDATE
  TICKET_STATUS_CHANGE
  TICKET_ASSIGN
  TICKET_COMMENT_ADD
  TICKET_DELETE
  // COMMUNICATIONS
  COMMUNICATION_CREATE_DRAFT
  COMMUNICATION_EDIT_DRAFT
  COMMUNICATION_SEND
  COMMUNICATION_READ
  // DOCUMENTS
  FILE_UPLOADED
  DOCUMENT_CREATE
  DOCUMENT_VISIBILITY_CHANGED
  DOCUMENT_DOWNLOADED
  DOCUMENT_DELETE
  // FINANCE
  CHARGE_CREATE
  CHARGE_CANCEL
  PAYMENT_SUBMIT
  PAYMENT_APPROVE
  PAYMENT_REJECT
  PAYMENT_ALLOCATE
  ALLOCATION_DELETE
  // VENDORS/OPS
  VENDOR_CREATE
  VENDOR_UPDATE
  VENDOR_DELETE
  VENDOR_ASSIGN
  VENDOR_UNASSIGN
  QUOTE_CREATE
  QUOTE_STATUS_CHANGE
  WORK_ORDER_CREATE
  WORK_ORDER_STATUS_CHANGE
}

model AuditLog {
  id                  String      @id @default(cuid())
  tenantId            String? // Nullable: SUPER_ADMIN actions are tenant-scoped, global actions are null
  actorUserId         String? // Nullable: system actions may have no actor
  actorMembershipId   String? // NEW: Link to Membership for tenant-scoped actions
  action              AuditAction
  entity              String // "Tenant", "Subscription", "User", "Ticket", "Building", etc.
  entityId            String // ID of the resource affected
  metadata            Json? // before/after values, details, request ID
  createdAt           DateTime    @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  actor  User?   @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([actorUserId])
  @@index([action])
  @@index([createdAt])
  @@index([entity])
}

// ============================================================================
// BILLING (OPCIÓN A2 — Foundation for SaaS)
// ============================================================================

enum BillingPlanId {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL // Free trial period
  ACTIVE // Currently active
  PAST_DUE // Payment failed, but not canceled
  CANCELED // Canceled by user or admin
  EXPIRED // Trial ended without conversion
}

model BillingPlan {
  id           String        @id @default(cuid())
  planId       BillingPlanId @unique // Enum: FREE, BASIC, PRO, ENTERPRISE
  name         String // "Free", "Basic Plan", etc.
  description  String?
  monthlyPrice Int           @default(0) // in cents (0 = free)

  // Entitlements (A2)
  maxBuildings Int @default(1)
  maxUnits     Int @default(10)
  maxUsers     Int @default(3)
  maxOccupants Int @default(50)

  // Features flags
  canExportReports  Boolean @default(false)
  canBulkOperations Boolean @default(false)
  supportLevel      String  @default("COMMUNITY") // COMMUNITY, EMAIL, PRIORITY

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  @@index([planId])
}

model Subscription {
  id       String             @id @default(cuid())
  tenantId String             @unique // One active subscription per tenant
  planId   String // Foreign key to BillingPlan.id
  status   SubscriptionStatus @default(TRIAL)

  // Period tracking (for billing cycles)
  currentPeriodStart DateTime  @default(now())
  currentPeriodEnd   DateTime? // Null for active, set on cancel
  trialEndDate       DateTime? // Null if not in trial

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   BillingPlan         @relation(fields: [planId], references: [id], onDelete: Restrict)
  events SubscriptionEvent[]

  @@index([tenantId])
  @@index([planId])
  @@index([status])
}

model SubscriptionEvent {
  id             String   @id @default(cuid())
  subscriptionId String
  eventType      String // "CREATED", "UPGRADED", "DOWNGRADED", "CANCELED", "RENEWED"
  prevPlanId     String? // For upgrades/downgrades
  newPlanId      String? // For upgrades/downgrades
  metadata       Json? // Extra data (reason, etc.)
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================================================
// TICKETS (MVP — Maintenance requests / Reclamos)
// ============================================================================

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model Ticket {
  id                     String  @id @default(cuid())
  tenantId               String
  buildingId             String
  unitId                 String? // Optional: ticket may be building-wide
  createdByUserId        String
  assignedToMembershipId String? // Optional: ticket may not be assigned

  title       String
  description String
  category    String // "MAINTENANCE", "REPAIR", "CLEANING", "COMPLAINT", etc.
  priority    TicketPriority @default(MEDIUM)
  status      TicketStatus   @default(OPEN)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relations
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building   Building        @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit       Unit?           @relation(fields: [unitId], references: [id], onDelete: SetNull)
  createdBy  User            @relation("TicketCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
  assignedTo Membership?     @relation(fields: [assignedToMembershipId], references: [id], onDelete: SetNull)
  comments   TicketComment[]
  quotes     Quote[]
  workOrders WorkOrder[]

  @@index([tenantId, buildingId, status])
  @@index([assignedToMembershipId, status])
  @@index([unitId, status])
}

model TicketComment {
  id           String @id @default(cuid())
  tenantId     String
  ticketId     String
  authorUserId String

  body      String
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User   @relation("TicketCommentAuthor", fields: [authorUserId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([tenantId])
}

// ============================================================================
// COMMUNICATIONS (MVP — Comunicados / Announcements)
// ============================================================================

enum CommunicationChannel {
  IN_APP
  EMAIL
  WHATSAPP
  PUSH
}

enum CommunicationStatus {
  DRAFT
  SCHEDULED
  SENT
}

enum CommunicationTargetType {
  ALL_TENANT
  BUILDING
  UNIT
  ROLE
}

model Communication {
  id         String  @id @default(cuid())
  tenantId   String
  buildingId String? // Nullable: comunicado puede ser cross-building o de un edificio específico

  title   String
  body    String
  channel CommunicationChannel
  status  CommunicationStatus  @default(DRAFT)

  createdByMembershipId String
  scheduledAt           DateTime?
  sentAt                DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant              Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building            Building?              @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  createdByMembership Membership             @relation(fields: [createdByMembershipId], references: [id], onDelete: Cascade)
  targets             CommunicationTarget[]
  receipts            CommunicationReceipt[]

  @@index([tenantId, status])
  @@index([tenantId, buildingId, status])
  @@index([createdByMembershipId])
}

model CommunicationTarget {
  id              String @id @default(cuid())
  tenantId        String
  communicationId String

  targetType CommunicationTargetType
  targetId   String? // buildingId/unitId/roleCode según targetType

  createdAt DateTime @default(now())

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  communication Communication @relation(fields: [communicationId], references: [id], onDelete: Cascade)

  @@index([communicationId])
  @@index([tenantId, targetType])
}

model CommunicationReceipt {
  id              String @id @default(cuid())
  tenantId        String
  communicationId String
  userId          String

  deliveredAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  communication Communication @relation(fields: [communicationId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communicationId, userId])
  @@index([tenantId, userId, readAt])
  @@index([communicationId, readAt])
}

// ============================================================================
// DOCUMENTS & FILES (MVP — Documentos, Reglas, Actas, Contratos, etc.)
// ============================================================================

enum DocumentCategory {
  RULES // Reglamento/Normas
  MINUTES // Actas de asambleas
  CONTRACT // Contratos
  BUDGET // Presupuestos
  INVOICE // Facturas
  RECEIPT // Recibos/Comprobantes
  OTHER // Otro
}

enum DocumentVisibility {
  TENANT_ADMINS // Solo admins del tenant
  RESIDENTS // Visibles a residents (y admins)
  PRIVATE // Solo quien lo creó (y admins)
}

// ============================================================================
// VENDORS & OPERATIONS (MVP — Proveedores, Presupuestos, Órdenes de Trabajo)
// ============================================================================

enum QuoteStatus {
  REQUESTED // Presupuesto solicitado
  RECEIVED // Presupuesto recibido del proveedor
  APPROVED // Presupuesto aprobado
  REJECTED // Presupuesto rechazado
}

enum WorkOrderStatus {
  OPEN // Orden abierta / creada
  IN_PROGRESS // Orden en proceso
  DONE // Orden completada
  CANCELLED // Orden cancelada
}

// ============================================================================
// File: Metadata de archivos almacenados en MinIO
// Relación 1:1 con Document (cada documento tiene exactamente 1 archivo)
// ON DELETE: CUANDO se borra Document, se borra File (y se debe limpiar MinIO)
// ============================================================================
model File {
  id       String @id @default(cuid())
  tenantId String

  // MinIO metadata
  bucket       String // Bucket name in MinIO
  objectKey    String // Full path/key in MinIO (e.g., "tenant-a/documents/rules.pdf")
  originalName String // Original filename (for download)
  mimeType     String // MIME type (e.g., "application/pdf")
  size         Int // File size in bytes
  checksum     String? // SHA-256 or other hash for integrity check (optional)

  // Audit trail
  createdByMembershipId String? // Who uploaded the file (nullable for system uploads)
  createdAt             DateTime @default(now())

  // Relations
  tenant              Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByMembership Membership? @relation(fields: [createdByMembershipId], references: [id], onDelete: SetNull)
  document            Document? // 1:1 relation (back-reference, defined in Document)
  quotes              Quote[] // 0..N relation (a file can be associated with multiple quotes, or none)
  paymentProofs       Payment[] // 0..N relation (payment proof files)

  @@unique([tenantId, bucket, objectKey])
  @@index([tenantId, createdAt])
  @@index([tenantId, objectKey])
}

// ============================================================================
// Document: Metadata y permisos de documentos (reglas, actas, contratos, etc.)
// Relación 1:1 con File (cada documento tiene exactamente 1 archivo)
//
// REGLA: Document debe estar asociado a EXACTAMENTE uno de:
//   A) buildingId (documento de edificio específico)
//   B) unitId (documento de unidad específica)
//   C) Ninguno (documento de tenant-wide, aplica a todo el tenant)
//
// Validación debe hacerse en la aplicación/servicio (Prisma no lo garantiza solo)
// ============================================================================
model Document {
  id       String @id @default(cuid())
  tenantId String
  fileId   String @unique // 1:1 relation with File

  title      String // Display name
  category   DocumentCategory
  visibility DocumentVisibility @default(TENANT_ADMINS)

  // Scope: debe ser exactamente uno de buildingId, unitId, o ninguno
  buildingId String? // If building-scoped
  unitId     String? // If unit-scoped (implies building-scoped as well)

  // Audit trail
  createdByMembershipId String? // Who uploaded/created (nullable for system docs)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  tenant              Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  file                File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  building            Building?   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                Unit?       @relation(fields: [unitId], references: [id], onDelete: Cascade)
  createdByMembership Membership? @relation(fields: [createdByMembershipId], references: [id], onDelete: SetNull)

  @@index([tenantId, category])
  @@index([tenantId, buildingId])
  @@index([tenantId, unitId])
  @@index([tenantId, visibility])
}

// ============================================================================
// Vendor: Proveedores (plomeros, electricistas, ascensoristas, etc.)
// ============================================================================
model Vendor {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  taxId     String? // RUT/CUIT/VAT número (nullable)
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignments   VendorAssignment[]
  quotes        Quote[]
  workOrders    WorkOrder[]

  // Unique constraint to prevent duplicate vendors in same tenant
  @@unique([tenantId, name])
  @@index([tenantId, name])
}

// ============================================================================
// VendorAssignment: Asignación de proveedor a un building para servicio específico
// e.g., "Plomería Express" para edificio "Avenida 9 de Julio 100"
// ============================================================================
model VendorAssignment {
  id          String   @id @default(cuid())
  tenantId    String
  vendorId    String
  buildingId  String
  serviceType String // "PLUMBING", "ELECTRICITY", "ELEVATOR", "GENERAL", etc.
  createdAt   DateTime @default(now())

  // Relations
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendor   Vendor  @relation(fields: [vendorId], references: [id], onDelete: Restrict) // Can't delete vendor if assigned
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  // Unique: one vendor per building per service type
  @@unique([vendorId, buildingId, serviceType])
  @@index([tenantId, buildingId])
  @@index([tenantId, vendorId])
}

// ============================================================================
// Quote: Presupuestos/cotizaciones de proveedores
// Puede estar asociado opcionalmente a un ticket (reclamo)
// ============================================================================
model Quote {
  id        String      @id @default(cuid())
  tenantId  String
  buildingId String
  vendorId  String
  ticketId  String? // Optional: quote may not be tied to a specific ticket
  fileId    String? // Optional: PDF del presupuesto
  amount    Int // Amount in cents (e.g., 10000 = $100.00)
  currency  String      @default("ARS") // ARS, USD, etc.
  status    QuoteStatus @default(REQUESTED)
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  vendor  Vendor   @relation(fields: [vendorId], references: [id], onDelete: Restrict) // Can't delete vendor if has quotes
  ticket  Ticket?  @relation(fields: [ticketId], references: [id], onDelete: SetNull) // Keep quote if ticket deleted
  file    File?    @relation(fields: [fileId], references: [id], onDelete: SetNull) // Keep quote if file deleted

  @@index([tenantId, buildingId, status])
  @@index([tenantId, ticketId])
  @@index([tenantId, vendorId])
}

// ============================================================================
// WorkOrder: Órdenes de trabajo (asignaciones de tareas a proveedores/operadores)
// Puede estar asociada opcionalmente a un ticket (reclamo)
// Puede estar asignada a un operador interno (Membership) o a un proveedor externo (Vendor)
// ============================================================================
model WorkOrder {
  id                     String           @id @default(cuid())
  tenantId               String
  buildingId             String
  ticketId               String? // Optional: work order may not be tied to a specific ticket
  vendorId               String? // Optional: external vendor (if null, assigned to operator)
  assignedToMembershipId String? // Optional: internal operator
  status                 WorkOrderStatus @default(OPEN)
  description           String?
  scheduledFor          DateTime? // When the work is scheduled to happen
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  closedAt              DateTime? // When the work was completed

  // Relations
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building       Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  ticket         Ticket?     @relation(fields: [ticketId], references: [id], onDelete: SetNull) // Keep work order if ticket deleted
  vendor         Vendor?     @relation(fields: [vendorId], references: [id], onDelete: SetNull) // Keep work order if vendor deleted
  assignedTo     Membership? @relation("WorkOrderAssignedTo", fields: [assignedToMembershipId], references: [id], onDelete: SetNull)

  @@index([tenantId, buildingId, status])
  @@index([tenantId, ticketId])
  @@index([assignedToMembershipId, status])
}

// ============================================================================
// FINANZAS: Charge (Cargo/Expensa por unidad)
// ============================================================================
model Charge {
  id                     String      @id @default(cuid())
  tenantId               String
  buildingId             String
  unitId                 String
  period                 String      // YYYY-MM format (e.g., "2026-02")
  type                   ChargeType  @default(COMMON_EXPENSE)
  concept                String      // e.g., "Expensas Comunes Febrero 2026"
  amount                 Int         // Amount in cents (e.g., 10000 = $100.00)
  currency               String      @default("ARS")
  dueDate                DateTime
  status                 ChargeStatus @default(PENDING)
  createdByMembershipId  String?     // Who created this charge (admin)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  canceledAt             DateTime?

  // Relations
  tenant                Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building              Building              @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                  Unit                  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  createdByMembership   Membership?           @relation(fields: [createdByMembershipId], references: [id], onDelete: SetNull)
  paymentAllocations    PaymentAllocation[]

  @@unique([unitId, period, concept]) // One charge per unit/period/concept
  @@index([tenantId, buildingId, period])
  @@index([tenantId, unitId, status])
  @@index([tenantId, buildingId, status])
  @@index([dueDate])
}

// ============================================================================
// FINANZAS: Payment (Pago de residente)
// ============================================================================
model Payment {
  id                       String         @id @default(cuid())
  tenantId                 String
  buildingId               String
  unitId                   String?        // Optional: payment may be for building (not unit-specific)
  amount                   Int            // Amount in cents
  currency                 String         @default("ARS")
  method                   PaymentMethod
  status                   PaymentStatus  @default(SUBMITTED)
  paidAt                   DateTime?      // When the payment was actually received
  reference                String?        // Payment reference (operation number, receipt)
  proofFileId              String?        // Link to proof document
  createdByUserId          String         // Who submitted the payment (resident)
  reviewedByMembershipId   String?        // Who approved the payment (admin)
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  // Relations
  tenant                  Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  building                Building            @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit                    Unit?               @relation(fields: [unitId], references: [id], onDelete: SetNull)
  createdByUser           User                @relation("PaymentCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  reviewedByMembership    Membership?         @relation(fields: [reviewedByMembershipId], references: [id], onDelete: SetNull)
  proofFile               File?               @relation(fields: [proofFileId], references: [id], onDelete: SetNull)
  paymentAllocations      PaymentAllocation[]

  @@index([tenantId, buildingId, status])
  @@index([tenantId, unitId, status])
  @@index([tenantId, createdByUserId])
  @@index([status])
}

// ============================================================================
// FINANZAS: PaymentAllocation (Imputación de pago a cargo)
// ============================================================================
model PaymentAllocation {
  id        String   @id @default(cuid())
  tenantId  String
  paymentId String
  chargeId  String
  amount    Int      // Amount allocated (in cents, must be <= Payment.amount)
  createdAt DateTime @default(now())

  // Relations
  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  charge    Charge  @relation(fields: [chargeId], references: [id], onDelete: Restrict) // Protect charge history

  @@unique([paymentId, chargeId]) // One allocation per payment/charge pair
  @@index([tenantId, paymentId])
  @@index([tenantId, chargeId])
}
